zookeeper
    zookeeper功能
        服务注册与发现
            75.1.激活
            75.2.向Zookeeper注册
            75.3.使用DiscoveryClient
        服务注册中心
            77.1.实例状态
        统一命名服务
        配置管理
        集群管理
            集群机器监控
            master选举
        数据发布和订阅
        分布通知/协调
            心跳检测机制
            系统调度模式
            工作汇报模式
        分布式锁
            保持独占
            控制时序
        队列管理
        服务器动态上下线
            服务器在ZK/servers下创建 临时带序号 的节点
            客户端监听/servers下节点的变化
        负责存储和管理大家都关心的数据
        接收观察者的注册
        负责通知已经在Zookeeper上注册的观察者
    使用配置
        本地模式安装
            准备
                安装JDK
                上传Zookeeper安装包到Linux系统下
                解压到指定目录
                    tar -zxvf a -C b
            配置修改
                zoo_sample.cfg修改为zoo.cfg
                创建zkData目录
                    在Zookeeper目录下创建
                修改zoo.cfg
                    dataDir=/path/to/zookeeper/zkData
            操作Zookeeper
                启动
                    bin/zkServer.sh start
                查看进程
                    jps
                    QuorumPeerMain
                查看状体
                    bin/zkServer.sh status
                启动客户端
                    bin/zkCli.sh
                退出客户端
                    quit
                停止
                    bin/zkServer.sh stop
        分布式安装部署
            集群规划
                3个节点
                    hadoop102
                    hadoop103
                    hadoop104
            在hadoop102上安装配置
                安装
                    tart -zxvf zookeeper-3.4.10.tar.gz -C /opt/module
                创建zkData目录
                    在zkData目录下创建myid文件
                        echo 2&gt;&gt;myid
                配置
                    zoo.cfg
                        dataDir=/opt/module/zookeeper-3.4.10/zkData
                        server.2=hadoop102:2888:3888
                            2888是这个服务器与集群中的Leader服务器交换信息的端口
                            3888是万一集群中的leader服务器挂了，需要一个端口来重新进行选举，选出一个新的leader，而这个端口就是用来执行选举时服务器互相通信的端口
                        server.3=hadoop103:2888:3888
                        server.4=hadoop104:2888:3888
            分发到hadoop103，hadoop104
                分别在hadoop103，hadoop104上修改dataDir/myi中的值为3，4
            集群操作
                三台机器分别启动Zookeeper
                    bin/zkServer.sh start
                查看状态
                    bin/zkServer.sh status
                        JMX enabled by default&lt;br&gt;&lt;br&gt;Using config: /opt/module/zookeeper-3.4.10/bin/../conf/zoo.cfg&lt;br&gt;&lt;br&gt;Mode: follower
        API应用
            jar
                org.apache.logging.log4j:log4j-core:2.8.2
                org.apache.zookeeper:zookeeper:3.4.10
            类
                ZooKeeper
        监听服务器节点动态上下线案例
            类
                ZooKeeper
                Watcher
        zoo.cfg
            tickTime=2000
                通信心跳时间
                    包括Client和Server之间、Server与Server之间
            initLimit=10
                Leader和Follower初始连接最大心跳数
                    20S连接不上就不在尝试连接了
            syncLimit=5
                LF同步通信时限
                    10S未收到Follower心跳，认为F死掉
            dataDir=/tmp/zookeeper
                数据保存地址
                    一般不使用默认的tmp目录
            clientPort=2181
                客户端连接默认端口
    zookeeper原理
        数据写入
            连接Leader
                Leader收到请求后，先写入自己库中，再分发给Follower
                Leader收到ack后，包括自己超过半数后，返回ack给客户端
            连接Follower
                Follower会将请求转发给Leader
                Leader按照直连Leader处理
                Leader将ack发送给Follower，尤其给客户端
        节点类型
            节点类型
                持久
                    客户端和服务器断开连接后，创建的节点不删除
                短暂
                    客户端和服务器断开连接后，创建的节点自己删除
                持久不带序号（Persistent）
                    create /path data
                持久带序号（Persistent_Sequential）
                    create -s /path data
                短暂不带序号（Ephemeral）
                    create -e /path data
                短暂带序号（Ephemeral_Sequential）
                    create -es /path data
            顺序节点
                创建节点时设置顺序标识，znode名称后会附加一个值，顺序号是一个单调递增的计数器，由父节点维护
        zookeeper保证了如下分布式一致性特征
            「顺序一致性」
            「原子性」：
            「单一视图」：
            「可靠性：」
            「实时性（最终一致性）：」
        zab协议
            崩溃恢复
                选举机制
                    Server工作状态
                    半数机制
                        集群中半数以上机器存活，集群可用
                        Zookeeper适合安装奇数台服务器
                    配置文件中未配置Master和Slave
                        Zookeeper工作时，是有一个节点为leader，其他则为Follower
                        Leader是通过内部的选举机制临时产生的
                    过程
                        第一次启动
                            1、每台服务器启动时都将选票投给自己
                            2、启动两台以上服务器时，myid大的获得所有选票
                            3、获得半数选票的当选Leader，其他的为Follower
                            4、后续启动的服务器自动变成Follower
                            未选出Leader时，服务器状态都为LOOKING
                        非第一次启动
                            基本概念
                                Epoch
                                    每个Leader任期的代号
                                ZXID
                                    事务ID
                                        leader周期
                                SID
                                    服务器ID（myid）
                            按照Epoch、ZXID、SID顺序大的当选
            消息广播
    zookeeper组成
        运维
            四字命令
            性能维度
            监控工具
        客户端
            curator
                缓存
                队列
                栅栏
                锁
                计数器
            zkclient
        日志
            currentEpoch
            acceptEpoch
            事务日志
            快照
        一主多从的服务器角色
            「Leader」
            「Follower」
            「Observer」
        数据结构
            每个节点称作一个ZNode
                一个ZNode能储存1MB数据
    zookeeper特性
        集群只要有半数以上节点存活，就能正常提供服务
            一般安装奇数台服务器
        一个领导者，多个观察者组成的集群
        全局数据一致
            全局数据一致，Leader负责写入，Follower同步数据
            每个server保存一份相同的数据副本，Client无论连接到哪个Server，数据都是一致的
        更新请求顺序进行
            来自同一个client的更新请求按其发送顺序一次执行
        数据更新原子性
            一次数据更新要么成功，要么失败
        实时性
            在一定范围内，client能读到最新数据